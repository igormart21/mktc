{% extends 'base.html' %}
{% load static %}

{% block title %}Carrinho de Compras{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h1 class="h4 mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Carrinho de Compras
                    </h1>
                </div>
                <div class="card-body">
                    {% if carrinho %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-success">
                                    <tr>
                                        <th>Produto</th>
                                        <th class="text-center">Quantidade</th>
                                        <th class="text-end">Preço Unitário</th>
                                        <th class="text-end">Preço Total</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in carrinho %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if item.produto.imagem %}
                                                        <img src="{{ item.produto.imagem.url }}" alt="{{ item.produto.nome }}" 
                                                             class="img-thumbnail me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% endif %}
                                                    <span>{{ item.produto.nome }}</span>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <form action="{% url 'core:diminuir_quantidade' item.produto.id %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-success btn-sm me-1" title="Diminuir quantidade">
                                                        <i class="fas fa-minus"></i>
                                                    </button>
                                                </form>
                                                {{ item.quantidade }}
                                            </td>
                                            <td class="text-end">R$ {{ item.preco|floatformat:2 }}</td>
                                            <td class="text-end">R$ {{ item.preco_total|floatformat:2 }}</td>
                                            <td class="text-center">
                                                <form action="{% url 'core:remover_do_carrinho' item.produto.id %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                            title="Remover do carrinho">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-success">
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                        <td class="text-end"><strong class="text-success">R$ {{ carrinho.get_preco_total|floatformat:2 }}</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h3 class="h5 mb-0">Finalizar Compra</h3>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" action="{% url 'core:checkout' %}" id="finalizar-compra-form">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="tipo_venda" class="form-label">Tipo de Venda</label>
                                                <select name="tipo_venda" id="tipo_venda" class="form-select" required>
                                                    <option value="">Selecione o tipo de venda</option>
                                                    <option value="avista">À Vista</option>
                                                    <option value="prazo">A Prazo</option>
                                                </select>
                                            </div>

                                            <div id="venda_prazo_form" style="display: none;">
                                                {{ form.as_p }}
                                            </div>

                                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                                <a href="{% url 'core:catalogo' %}" class="btn btn-outline-secondary me-2">
                                                    <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
                                                </a>
                                                <button type="submit" class="btn btn-success" id="btn-finalizar-compra">
                                                    <i class="fas fa-check me-2"></i>Finalizar Compra
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-4x text-success mb-3"></i>
                            <h3 class="h4 text-success">Seu carrinho está vazio</h3>
                            <p class="text-muted">Adicione produtos ao seu carrinho para começar a comprar</p>
                            <a href="{% url 'core:catalogo' %}" class="btn btn-success mt-3">
                                <i class="fas fa-store me-2"></i>Ir para o catálogo
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Função para validar Inscrição Estadual
    function validarInscricaoEstadual(inscricao) {
        // Remove caracteres não numéricos
        inscricao = inscricao.replace(/[^\d]/g, '');
        // Verifica se tem pelo menos 8 dígitos e no máximo 14
        return inscricao.length >= 8 && inscricao.length <= 14;
    }

    // Função para validar tamanho e extensão do arquivo
    function validarArquivo(arquivo) {
        const maxSize = 5 * 1024 * 1024; // 5MB em bytes
        const extensoesPermitidas = ['pdf', 'jpg', 'jpeg', 'png'];
        const extensao = arquivo.name.split('.').pop().toLowerCase();
        
        if (!extensoesPermitidas.includes(extensao)) {
            return { valido: false, mensagem: 'Formato de arquivo inválido. Use PDF, JPG ou PNG.' };
        }
        if (arquivo.size > maxSize) {
            return { valido: false, mensagem: 'O arquivo deve ter no máximo 5MB.' };
        }
        return { valido: true };
    }

    // Função para mostrar mensagem de erro com animação
    function mostrarErro(campo, mensagem) {
        limparErro(campo); // Limpa erro anterior
        
        const divFeedback = document.createElement('div');
        divFeedback.className = 'invalid-feedback d-block';
        divFeedback.textContent = mensagem;
        campo.classList.add('is-invalid');
        
        // Adiciona classe para animação
        divFeedback.style.opacity = '0';
        campo.parentElement.appendChild(divFeedback);
        
        // Força reflow para animação funcionar
        divFeedback.offsetHeight;
        divFeedback.style.transition = 'opacity 0.3s ease-in-out';
        divFeedback.style.opacity = '1';
    }

    // Função para limpar erro
    function limparErro(campo) {
        campo.classList.remove('is-invalid');
        const divFeedback = campo.parentElement.querySelector('.invalid-feedback');
        if (divFeedback) {
            divFeedback.remove();
        }
    }

    // Função para alternar campos do formulário de venda a prazo
    function toggleFormFields() {
        const tipoVenda = document.getElementById('tipo_venda').value;
        const formPrazo = document.getElementById('venda_prazo_form');
        const isArrendatario = document.getElementById('id_is_arrendatario');
        const docArrendamento = document.getElementById('id_documento_arrendamento');
        const inscricaoEstadual = document.getElementById('id_inscricao_estadual');
        const documentoMatricula = document.getElementById('id_documento_matricula');

        if (tipoVenda === 'prazo') {
            formPrazo.style.display = 'block';
            formPrazo.style.opacity = '0';
            setTimeout(() => {
                formPrazo.style.transition = 'opacity 0.3s ease-in-out';
                formPrazo.style.opacity = '1';
            }, 10);
            if (inscricaoEstadual) inscricaoEstadual.required = true;
            if (documentoMatricula) documentoMatricula.required = true;
            if (isArrendatario && isArrendatario.checked && docArrendamento) {
                docArrendamento.required = true;
            }
        } else {
            formPrazo.style.opacity = '0';
            setTimeout(() => {
                formPrazo.style.display = 'none';
            }, 300);
            if (inscricaoEstadual) inscricaoEstadual.required = false;
            if (documentoMatricula) documentoMatricula.required = false;
            if (docArrendamento) docArrendamento.required = false;
        }
    }

    // Inicializar ao carregar a página
    document.addEventListener('DOMContentLoaded', function() {
        const tipoVendaSelect = document.getElementById('tipo_venda');
        const form = document.getElementById('finalizar-compra-form');
        const isArrendatario = document.getElementById('id_is_arrendatario');
        const btnSubmit = document.getElementById('btn-finalizar-compra');
        
        // Configurar evento de mudança no tipo de venda
        tipoVendaSelect.addEventListener('change', toggleFormFields);
        
        // Configurar evento de mudança no checkbox de arrendatário
        if (isArrendatario) {
            isArrendatario.addEventListener('change', function() {
                const docArrendamento = document.getElementById('id_documento_arrendamento');
                if (docArrendamento) {
                    docArrendamento.required = this.checked;
                    if (!this.checked) {
                        limparErro(docArrendamento);
                    }
                }
            });
        }
        
        // Configurar validação do formulário
        form.addEventListener('submit', function(e) {
            const tipoVenda = tipoVendaSelect.value;
            let temErro = false;
            
            // Limpar erros anteriores
            form.querySelectorAll('.is-invalid').forEach(campo => limparErro(campo));
            
            if (!tipoVenda) {
                e.preventDefault();
                mostrarErro(tipoVendaSelect, 'Por favor, selecione o tipo de venda.');
                temErro = true;
            }
            
            if (tipoVenda === 'prazo') {
                const inscricaoEstadual = document.getElementById('id_inscricao_estadual');
                const docMatricula = document.getElementById('id_documento_matricula');
                const docArrendamento = document.getElementById('id_documento_arrendamento');
                
                // Validar Inscrição Estadual
                if (!inscricaoEstadual.value.trim() || !validarInscricaoEstadual(inscricaoEstadual.value)) {
                    mostrarErro(inscricaoEstadual, 'Inscrição Estadual deve ter entre 8 e 14 dígitos.');
                    temErro = true;
                }
                
                // Validar Documento de Matrícula
                if (!docMatricula.files.length) {
                    mostrarErro(docMatricula, 'Por favor, anexe o Documento de Matrícula.');
                    temErro = true;
                } else {
                    const validacao = validarArquivo(docMatricula.files[0]);
                    if (!validacao.valido) {
                        mostrarErro(docMatricula, validacao.mensagem);
                        temErro = true;
                    }
                }
                
                // Validar Documento de Arrendamento se for arrendatário
                if (isArrendatario && isArrendatario.checked) {
                    if (!docArrendamento.files.length) {
                        mostrarErro(docArrendamento, 'Por favor, anexe o Documento de Arrendamento.');
                        temErro = true;
                    } else {
                        const validacao = validarArquivo(docArrendamento.files[0]);
                        if (!validacao.valido) {
                            mostrarErro(docArrendamento, validacao.mensagem);
                            temErro = true;
                        }
                    }
                }
            }
            
            if (temErro) {
                e.preventDefault();
                // Rolar até o primeiro erro com animação suave
                const primeiroErro = form.querySelector('.is-invalid');
                if (primeiroErro) {
                    primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                // Desabilitar botão e mostrar loading
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
            }
        });
        
        // Adicionar preview de arquivos
        const camposArquivo = form.querySelectorAll('input[type="file"]');
        camposArquivo.forEach(campo => {
            campo.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const arquivo = this.files[0];
                    const validacao = validarArquivo(arquivo);
                    
                    if (!validacao.valido) {
                        mostrarErro(this, validacao.mensagem);
                        this.value = ''; // Limpa o campo
                    } else {
                        limparErro(this);
                        // Mostrar nome do arquivo selecionado
                        const label = this.parentElement.querySelector('label');
                        if (label) {
                            label.textContent = `Arquivo selecionado: ${arquivo.name}`;
                        }
                    }
                }
            });
        });

        // Adicionar evento de mudança no select
        if (tipoVendaSelect) {
            tipoVendaSelect.addEventListener('change', toggleFormFields);
            // Executar uma vez para garantir o estado inicial correto
            toggleFormFields();
        }
    });
</script>
{% endblock %}

{% endblock %} 